<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Medieval Murder Mystery</title>
  <style>
    :root {
      --bg: #1f1b16;
      --panel: #2b241c;
      --panel-dark: #17130f;
      --accent: #4b3e30;
      --text: #f5e9d6;
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
    }

    h1 { font-size: 1.25rem; }
    h2 { font-size: 1.1rem; }
    h3 { font-size: 0.95rem; }

    .container {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      padding: 0.75rem;
    }

    .panel {
      background: var(--panel);
      border-radius: 12px;
      padding: 0.75rem;
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
    }

    select, button {
      width: 100%;
      padding: 0.75rem;
      margin-top: 0.5rem;
      background: var(--accent);
      color: var(--text);
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      touch-action: manipulation;
    }

    button:active { transform: scale(0.98); }

    .stats {
      display: grid;
      grid-template-columns: 1fr auto;
      row-gap: 0.25rem;
      font-size: 0.9rem;
    }

    .items > div {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      margin-bottom: 0.25rem;
    }

    .items button {
      width: 42px;
      padding: 0.5rem;
      font-size: 1.1rem;
    }

    .log {
      height: 200px;
      overflow-y: auto;
      background: var(--panel-dark);
      padding: 0.5rem;
      border-radius: 8px;
      font-size: 0.8rem;
    }

    .log div { margin-bottom: 0.25rem; }

    .success { color: #4caf50; font-weight: 600; }
    .fail { color: #e53935; font-weight: 600; }

    @media (min-width: 768px) {
      .container { flex-direction: row; align-items: flex-start; }
      .panel { flex: 1; }
      .panel:first-child { max-width: 320px; }
    }
  </style>
</head>
<body>

<h1 style="padding:0.75rem">üó°Ô∏è Medieval Murder Mystery</h1>

<div class="container">
  <div class="panel">
    <h2>Character</h2>
    <select id="characterSelect"></select>

    <h3>Stats</h3>
    <div class="stats" id="stats"></div>

    <h3>Adjust Stats</h3>
    <div class="items" id="items"></div>
  </div>

  <div class="panel">
    <h2>Interaction</h2>
    <select id="npcSelect"></select>

    <h3>Action</h3>
    <button onclick="interact('charm')">Charm</button>
    <button onclick="interact('steal')">Steal</button>
    <button onclick="interact('attack')">Attack</button>

    <h3>Attack Type</h3>
    <select id="attackType">
      <option value="melee">Melee</option>
      <option value="ranged">Ranged</option>
      <option value="magic">Magic</option>
    </select>

    <h3>Event Log</h3>
    <div class="log" id="log"></div>
  </div>
</div>

<script>
function setCookie(name, value, days = 7) {
  const expires = new Date(Date.now() + days*864e5).toUTCString();
  document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/`;
}

function getCookie(name) {
  return document.cookie.split('; ').reduce((r, v) => {
    const parts = v.split('=');
    return parts[0] === name ? decodeURIComponent(parts[1]) : r;
  }, null);
}

const npcs = {
  Queen:{ cha:6, int:5, dex:3, str:2 },
  Prince:{ cha:4, str:4, dex:3, int:2 },
  Princess:{ cha:5, int:4, dex:3, str:1 },
  'Royal Dog':{ cha:1, dex:5, str:3 },
  'Shop Keeper':{ cha:3, int:4, dex:3 },
  'Fortune Teller':{ cha:4, int:5, dex:2 },
  'Guard 1':{ str:4, dex:3, cha:2 },
  'Guard 2':{ str:4, dex:2, cha:2 },
  'Town Folk 1':{ cha:3, dex:2 },
  'Town Folk 2':{ cha:2, dex:3 },
  'Town Beggar':{ cha:4, dex:3 }
};

const characters = {
  Rogue: { str:2, dex:5, con:3, int:2, luck:3, cha:3, constitution:2 },
  Knight:{ str:5, dex:2, con:4, int:1, luck:2, cha:2, constitution:3 },
  Mage:  { str:1, dex:2, con:2, int:5, luck:3, cha:3, constitution:1 },
  Bard:  { str:2, dex:3, con:3, int:3, luck:2, cha:5, constitution:2 }
};

let currentCharacter = null;
let currentCharacterName = null;

const charSelect = document.getElementById('characterSelect');
const npcSelect = document.getElementById('npcSelect');
const statsDiv = document.getElementById('stats');
const itemsDiv = document.getElementById('items');
const logDiv = document.getElementById('log');

Object.keys(characters).forEach(c => charSelect.add(new Option(c,c)));
Object.keys(npcs).forEach(n => npcSelect.add(new Option(n,n)));
npcSelect.add(new Option('Another Player','Another Player'));

function loadCharacterFromCookie() {
  const savedName = getCookie('mm_character_name');
  const savedStats = getCookie('mm_character_stats');

  if (savedName && savedStats && characters[savedName]) {
    currentCharacterName = savedName;
    currentCharacter = JSON.parse(savedStats);
    charSelect.value = savedName;
    log('Loaded saved character');
  } else {
    currentCharacterName = charSelect.value;
    currentCharacter = JSON.parse(JSON.stringify(characters[currentCharacterName]));
  }
}

function saveCharacterToCookie() {
  setCookie('mm_character_name', currentCharacterName);
  setCookie('mm_character_stats', JSON.stringify(currentCharacter));
}

charSelect.onchange = () => {
  currentCharacterName = charSelect.value;
  currentCharacter = JSON.parse(JSON.stringify(characters[currentCharacterName]));
  saveCharacterToCookie();
  renderStats();
  renderItems();
};

loadCharacterFromCookie();
renderStats();
renderItems();

function renderStats() {
  statsDiv.innerHTML = '';
  Object.entries(currentCharacter).forEach(([k,v]) => {
    statsDiv.innerHTML += `<div>${k.toUpperCase()}</div><div>${v}</div>`;
  });
}

function renderItems() {
  itemsDiv.innerHTML = '';
  Object.keys(currentCharacter).forEach(stat => {
    const row = document.createElement('div');
    const label = document.createElement('span');
    label.textContent = stat.toUpperCase();
    label.style.flex = '1';

    const minus = document.createElement('button');
    minus.textContent = '‚àí';
    minus.onclick = () => adjustStat(stat, -1);

    const plus = document.createElement('button');
    plus.textContent = '+';
    plus.onclick = () => adjustStat(stat, 1);

    row.append(label, minus, plus);
    itemsDiv.appendChild(row);
  });
}

function adjustStat(stat, delta) {
  currentCharacter[stat] = Math.max(0, currentCharacter[stat] + delta);
  saveCharacterToCookie();
  renderStats();
}

function getCooldownMs() {
  const base = 3 * 60 * 1000;
  const reduction = (currentCharacter.constitution || 0) * 15000;
  return Math.max(0, base - reduction);
}

function getNpcCooldownKey(npc) {
  return `mm_cd_${currentCharacterName}_${npc}`;
}

function isOnCooldown(npc) {
  const until = Number(getCookie(getNpcCooldownKey(npc)));
  return until && Date.now() < until;
}

function setCooldown(npc) {
  const until = Date.now() + getCooldownMs();
  setCookie(getNpcCooldownKey(npc), until);
}

function rollDice(stat) {
  return rollDiceFor(currentCharacter, stat);
}

function rollDiceFor(stats, stat) {
  const rolls = 1 + Math.floor((stats.luck || 0) / 3);
  let best = 0;
  for (let i = 0; i < rolls; i++) {
    best = Math.max(best, Math.floor(Math.random() * 20) + 1);
  }
  return best + (stats[stat] || 0);
}

function interact(type) {
  const target = npcSelect.value;

  if (target !== 'Another Player' && isOnCooldown(target)) {
    log(`<span class="fail">${target} is on cooldown ‚è≥</span>`);
    return;
  }

  let statUsed = 'cha';
  if (type === 'steal') statUsed = 'dex';
  if (type === 'attack') {
    const atk = document.getElementById('attackType').value;
    statUsed = atk === 'melee' ? 'str' : atk === 'ranged' ? 'dex' : 'int';
  }

  const playerRoll = rollDice(statUsed);

  if (target === 'Another Player') {
    log(`PVP ${type.toUpperCase()}: Roll = ${playerRoll} üé≤`);
    return;
  }

  const npc = npcs[target];
  const npcRoll = Math.floor(Math.random() * 20) + 1 + (npc[statUsed] || 0);
  const success = playerRoll > npcRoll;

  setCooldown(target);

  const outcomeText = success
    ? `<span class="success">SUCCESS üéâ</span>`
    : `<span class="fail">FAIL ‚ùå</span>`;

  log(`${type.toUpperCase()} vs ${target}: ${playerRoll} vs ${npcRoll} ‚Üí ${outcomeText}`);
}

function log(msg) {
  const div = document.createElement('div');
  div.innerHTML = msg;
  logDiv.prepend(div);
}
</script>

</body>
</html>

